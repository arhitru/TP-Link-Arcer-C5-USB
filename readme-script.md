Об этой сборке
    Модель: TP-Link Archer C5 v4
    Платформа: ramips/mt7620
    Версия: 24.10.5 (r29087-d9c5716d1d)

Понадобится USB-накопитель. ВСЕ данные на нём будут ПОТЕРЯНЫ.

Важные предупреждения:
    - Скрипт уничтожит все данные на /dev/sda
    - Устройство /dev/sda должно быть постоянно подключено
    - Рекомендуется сделать резервную копию конфигурации перед выполнением

Подготовка
- Убедиться, что в системе доступны пакеты: block-mount, kmod-fs-ext4, e2fsprogs, parted, kmod-usb-storage.
- Установить USB-накопитель в роутер.

Этот набор команд предназначен для расширения корневой файловой системы OpenWRT на отдельный раздел диска. Давайте разберем каждую команду:

## 1. **Настройка переменных**
```bash
DISK="/dev/sda"
```
Определяет целевой диск (обычно USB-накопитель или SSD).

## 2. **Создание раздела**
```bash
parted -s ${DISK} -- mklabel gpt mkpart extroot 2048s -2048s
```
- `mklabel gpt` - создает GPT таблицу разделов
- `mkpart extroot 2048s -2048s` - создает раздел от 2048-го сектора до предпоследнего 2048-го сектора
- `-s` - тихий режим (без запросов)

## 3. **Создание файловой системы**
```bash
DEVICE="${DISK}1"
mkfs.ext4 -L extroot ${DEVICE}
```
- Создает файловую систему ext4 на первом разделе
- `-L extroot` - устанавливает метку раздела

## 4. **Получение UUID нового раздела**
```bash
eval $(block info ${DEVICE} | grep -o -e 'UUID="\S*"')
```
Извлекает UUID созданного раздела в переменную `${UUID}`

## 5. **Получение текущей точки монтирования overlay**
```bash
eval $(block info | grep -o -e 'MOUNT="\S*/overlay"')
```
Находит текущую точку монтирования overlay (обычно внутренняя память) в переменную `${MOUNT}`

## 6. **Настройка fstab для нового корня**
```bash
uci -q delete fstab.extroot
uci set fstab.extroot="mount"
uci set fstab.extroot.uuid="${UUID}"
uci set fstab.extroot.target="${MOUNT}"
uci commit fstab
```
Настраивает автоматическое монтирование нового раздела как корневой файловой системы.

## 7. **Настройка fstab для оригинального overlay**
```bash
ORIG="$(block info | sed -n -e '/MOUNT="\S*\/overlay"/s/:\s.*$//p')"
```
Эта команда ищет оригинальное overlay устройство (обычно внутреннюю флеш-память маршрутизатора) и извлекает его путь (например, `/dev/mtdblock3`).

```bash
uci -q delete fstab.rwm
```
- **`uci`** - Unified Configuration Interface (основной инструмент управления конфигурацией OpenWRT)
- **`-q`** - quiet mode (подавляет вывод ошибок, если секция не существует)
- **`delete fstab.rwm`** - удаляет конфигурационную секцию с именем `rwm` в файле `/etc/config/fstab`
- Удаляет старую конфигурацию монтирования (если она существует)
- Это предотвращает конфликты при повторном выполнении скрипта

```bash
uci set fstab.rwm="mount"
```
- **`set fstab.rwm="mount"`** - создает новую секцию `rwm` типа `mount` в конфигурации fstab
- Создает секцию с именем `rwm` (read-write memory или read-write mount)
- Указывает, что это конфигурация точки монтирования (а не swap или что-то другое)
- В файле `/etc/config/fstab` это создаст:
  ```
  config mount 'rwm'
  ```

```bash
uci set fstab.rwm.device="${ORIG}"
```
- Устанавливает параметр `device` в секции `rwm`
- Значение - оригинальное устройство с overlay (внутренняя память)
- В файле конфигурации:
  ```
  config mount 'rwm'
      option device '/dev/mtdblock3'
  ```

```bash
uci set fstab.rwm.target="/rwm"
```
- Устанавливает точку монтирования `/rwm` для оригинального устройства
- `target` - это параметр, определяющий, куда будет смонтировано устройство
- В файле конфигурации:
  ```
  config mount 'rwm'
      option device '/dev/mtdblock3'
      option target '/rwm'
  ```

```bash
uci commit fstab
```
- Сохраняет изменения в постоянное хранилище
- Без этой команды изменения будут только в памяти и потеряются при перезагрузке
- Записывает изменения в файл `/etc/config/fstab`

```bash
config mount 'rwm'
    option device '/dev/mtdblock3'    # Оригинальное внутреннее устройство
    option target '/rwm'             # Точка монтирования
    option enabled '1'               # Автоматически добавляется
```

**Новый раздел (`/dev/sda1`)** → становится основным overlay (корневая ФС)
**Старый overlay (`/dev/mtdblock3`)** → монтируется как `/rwm`
**Сохраняем доступ к оригинальной памяти** - можно читать/записывать данные
**Резервное копирование** - можно копировать конфигурации обратно в оригинальную память
**Восстановление** - если внешний диск отключится, можно перемонтировать оригинальную память
**Экономия ресурсов** - используем оба устройства оптимально

## 8. **Копирование данных**
```bash
mount ${DEVICE} /mnt
```
- Монтирует новый раздел в `/mnt`

```bash
tar -C ${MOUNT} -cvf - . | tar -C /mnt -xf -
```
Это **конвейер (pipe)** из двух команд `tar`, разделенных символом `|`.

## **Разбор первой части: `tar -C ${MOUNT} -cvf - .`**

### **Параметры:**
- **`-C ${MOUNT}`** - Change directory (перейти в каталог `${MOUNT}`)
  - `${MOUNT}` = оригинальная точка монтирования overlay (например, `/overlay`)
  - Пример: `-C /overlay`

- **`-c`** - Create archive (создать архив)

- **`-v`** - Verbose (подробный вывод, показывает обрабатываемые файлы)

- **`-f -`** - File = stdout (использовать стандартный вывод как "файл" архива)
  - `-` означает стандартный вывод (stdout)
  - Вместо создания файла на диске, выводит архив в консоль

- **`.`** - Текущий каталог (тот, в который мы перешли с `-C`)
  - Архивирует ВСЕ содержимое каталога `${MOUNT}`

### **Что делает первая часть:**
```bash
# Эквивалент без конвейера:
cd /overlay
tar -cvf archive.tar .
```
Но вместо сохранения в файл `archive.tar`, выводит поток данных в конвейер.

## **Разбор символа `|` (pipe)**
- **`|`** - Конвейер (pipe)
- Перенаправляет **stdout (вывод)** первой команды в **stdin (ввод)** второй команды
- **Нет промежуточного файла** - данные передаются напрямую в памяти

## **Разбор второй части: `tar -C /mnt -xf -`**

### **Параметры:**
- **`-C /mnt`** - Change directory (перейти в `/mnt`)
  - `/mnt` - точка монтирования нового раздела

- **`-x`** - eXtract archive (распаковать архив)

- **`-f -`** - File = stdin (читать архив из стандартного ввода)
  - `-` означает стандартный ввод (stdin)

### **Что делает вторая часть:**
```bash
# Эквивалент без конвейера:
cd /mnt
tar -xvf archive.tar
```
Но вместо чтения из файла `archive.tar`, читает данные из конвейера.

## **Полный эквивалент без конвейера:**
```bash
# 1. Создать архив во временный файл
tar -C /overlay -cvf /tmp/backup.tar .

# 2. Распаковать архив
tar -C /mnt -xvf /tmp/backup.tar

# 3. Удалить временный файл
rm /tmp/backup.tar
```

## **Почему используют конвейер вместо файла?**

### **Преимущества:**
1. **Экономия места** - не нужен дополнительный свободный объем для временного файла
2. **Скорость** - данные передаются напрямую, без записи на диск
3. **Атомарность** - либо все скопируется, либо ничего (меньше риска повреждений)
4. **Безопасность** - нет временных файлов, которые можно удалить или повредить

### **Визуализация потока данных:**
```
/overlay/        → tar (упаковка) → stdout → pipe → stdin → tar (распаковка) → /mnt/
├── etc/                     │                           │                     ├── etc/
├── root/                   ▼                           ▼                     ├── root/
└── upper/           [бинарные данные           [распаковка в]               └── upper/
                     архива в потоке]             [памяти]
```

---

## **Что конкретно копируется?**

### **Содержимое `${MOUNT}` (обычно `/overlay`):**
```
/overlay/
├── etc/              # Конфигурации OpenWRT
│   ├── config/       # Файлы UCI конфигурации
│   ├── dropbear/     # SSH ключи
│   └── ...
├── root/             # Домашний каталог root
├── upper/            # OverlayFS: верхний слой
├── work/             # OverlayFS: рабочий каталог
└── ...
```

### **Важные особенности копирования:**
1. **Сохраняются права доступа** (permissions)
2. **Сохраняются владельцы файлов** (ownership)
3. **Сохраняются символические ссылки** (symlinks)
4. **Сохраняются временные метки** (timestamps)
5. **Рекурсивно копируются все подкаталоги**

Этот метод - стандартный и надежный способ миграции файловых систем в Unix-подобных ОС, особенно когда важно сохранить все метаданные файлов.

## **Цель скрипта:**
Перенести корневую файловую систему OpenWRT с ограниченной внутренней памяти на внешний накопитель для увеличения доступного пространства.

## **Важные предупреждения:**
1. Скрипт уничтожит все данные на `/dev/sda`
2. Требуется перезагрузка для применения изменений
3. Устройство `/dev/sda` должно быть постоянно подключено
4. Рекомендуется сделать резервную копию конфигурации перед выполнением
